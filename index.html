<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:image" content="opac-image.png">
    <title>План читання Біблії</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); min-height: 100vh; padding: 20px; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); text-align: center; }
        h1 { color: #4a90e2; font-size: 2.5em; margin-bottom: 10px; }
        .subtitle { color: #666; font-size: 1.1em; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: rgba(255, 255, 255, 0.95); padding: 14px 10px; border-radius: 12px; box-shadow: 0 3px 12px rgba(0,0,0,0.08); text-align: center; transition: transform 0.2s ease; min-height: 80px; display: flex; flex-direction: column; justify-content: center; }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-number { font-size: 1.8em; font-weight: bold; color: #4a90e2; display: block; }
        .stat-label { color: #666; margin-top: 4px; font-size: 0.8em; }
        .progress-bar { width: 100%; height: 8px; background: #e0e0e0; border-radius: 10px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4a90e2, #357abd); transition: width 0.3s ease; }
        .main-content { display: grid; grid-template-columns: 300px 1fr; gap: 20px; margin-bottom: 20px; }
        .sidebar { background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); height: fit-content; position: sticky; top: 20px; }
        .create-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: bold; cursor: pointer; margin-bottom: 20px; transition: transform 0.2s; }
        .create-btn:hover { transform: scale(1.05); }
        .menu-section { margin-bottom: 20px; }
        .menu-section h3 { color: #4a90e2; margin-bottom: 10px; font-size: 1em; }
        .menu-item { padding: 12px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
        .menu-item:hover, .menu-item.active { background: #4a90e2; color: white; border-color: #4a90e2; }
        .content-area { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .readings-grid { display: grid; gap: 15px; }
        .reading-card { background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; transition: all 0.3s; position: relative; }
        .reading-card:hover { box-shadow: 0 5px 20px rgba(74, 144, 226, 0.3); border-color: #4a90e2; }
        .reading-card.completed { border-left: 5px solid #4caf50; background: #f1f8f4; }
        .reading-card.current { border-left: 5px solid #ff9800; }
        .reading-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; }
        .reading-title { font-size: 1.3em; font-weight: bold; color: #333; }
        .reading-reference { color: #4a90e2; font-weight: 600; margin-bottom: 8px; }
        .reading-description { color: #666; line-height: 1.6; margin-bottom: 15px; font-size: 0.95em; }
        .reading-meta { display: flex; gap: 15px; flex-wrap: wrap; font-size: 0.9em; color: #999; margin-bottom: 15px; }
        .checkbox-label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 600; }
        .checkbox-label input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .reading-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
        .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; transition: all 0.3s; }
        .btn-ai { background: #9c27b0; color: white; }
        .btn-note { background: #2196f3; color: white; }
        .btn-delete { background: #f44336; color: white; }
        .notes-section { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 15px; display: none; }
        .notes-section.active { display: block; }
        .notes-section textarea { width: 100%; min-height: 80px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; resize: vertical; font-family: inherit; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { color: #4a90e2; }
        .close-btn { font-size: 2em; cursor: pointer; color: #999; border: none; background: none; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; font-family: inherit; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .btn-primary { background: #4a90e2; color: white; padding: 12px 30px; }
        .btn-secondary { background: #e0e0e0; color: #333; padding: 12px 30px; }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state-icon { font-size: 4em; margin-bottom: 20px; }
        .plan-templates { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .template-card { background: linear-gradient(135deg, #f5f7fa 0%, #e3edf7 100%); padding: 20px; border-radius: 12px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; text-align: center; }
        .template-card:hover { transform: translateY(-3px); border-color: #4a90e2; box-shadow: 0 5px 15px rgba(74, 144, 226, 0.3); }
        .template-icon { font-size: 2.5em; margin-bottom: 10px; }
        .template-title { font-weight: bold; color: #333; margin-bottom: 5px; }
        .template-desc { font-size: 0.85em; color: #666; }
        .ai-suggestions { background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 5px solid #9c27b0; }
        .ai-response-box { background: linear-gradient(135deg, #f3e5f522 0%, #e1bee733 100%); padding: 20px; border-radius: 12px; border-left: 5px solid #9c27b0; margin-top: 15px; }
        .loading { text-align: center; padding: 40px; }
        .spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid #e0e0e0; border-top-color: #4a90e2; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .tag { display: inline-block; padding: 4px 12px; background: #e3f2fd; color: #1976d2; border-radius: 15px; font-size: 0.85em; margin-right: 5px; }
        .share-buttons { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .share-btn { padding: 10px 20px; border-radius: 8px; text-decoration: none; color: white; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; transition: transform 0.2s; }
        .share-btn:hover { transform: scale(1.05); }
        .share-telegram { background: #0088cc; }
        .share-viber { background: #665cac; }
        @media (max-width: 968px) { 
            .main-content { grid-template-columns: 1fr; } 
            h1 { font-size: 1.8em; } 
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .sidebar { position: static; }
            .form-group textarea { min-height: 150px; font-size: 16px; }
            .form-group select { font-size: 16px; padding: 14px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>📖 План читання Біблії</h1>
            <p class="subtitle">"Слово Твоє — світильник для ноги моєї, і світло для стежки моєї" - Псалом 119:105</p>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-number" id="totalReadings">0</span>
                <div class="stat-label">Всього завдань</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="completedReadings">0</span>
                <div class="stat-label">Прочитано</div>
                <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="currentStreak">0</span>
                <div class="stat-label">Днів підряд</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="notesCount">0</span>
                <div class="stat-label">Нотаток</div>
            </div>
        </div>

        <div class="main-content">
            <aside class="sidebar">
                <button class="create-btn" onclick="app.openCreateModal()">✨ Створити план</button>
                
                <div class="menu-section">
                    <h3>Мої плани</h3>
                    <div id="plansList"></div>
                </div>

                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                    <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="app.exportData()">📥 Експорт</button>
                    <button class="btn btn-secondary" style="width: 100%;" onclick="app.openHelp()">❓ Довідка</button>
                </div>
            </aside>

            <main class="content-area">
                <div id="contentArea">
                    <div class="empty-state">
                        <div class="empty-state-icon">📖</div>
                        <h3>Почніть своє біблійне подорож</h3>
                        <p>Створіть план читання або оберіть готовий шаблон</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal: Create Plan -->
    <div class="modal" id="createModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>✨ Створити план читання</h2>
                <button class="close-btn" onclick="app.closeCreateModal()">&times;</button>
            </div>

            <div class="plan-templates">
                <div class="template-card" onclick="app.selectTemplate('custom')">
                    <div class="template-icon">✏️</div>
                    <div class="template-title">Свій план</div>
                    <div class="template-desc">Створити власний</div>
                </div>
                <div class="template-card" onclick="app.selectTemplate('year')">
                    <div class="template-icon">📅</div>
                    <div class="template-title">Рік</div>
                    <div class="template-desc">365 днів</div>
                </div>
                <div class="template-card" onclick="app.selectTemplate('nt')">
                    <div class="template-icon">✝️</div>
                    <div class="template-title">Новий Завіт</div>
                    <div class="template-desc">3 місяці</div>
                </div>
                <div class="template-card" onclick="app.selectTemplate('gospels')">
                    <div class="template-icon">📜</div>
                    <div class="template-title">Євангелія</div>
                    <div class="template-desc">30 днів</div>
                </div>
                <div class="template-card" onclick="app.selectTemplate('psalms')">
                    <div class="template-icon">🎵</div>
                    <div class="template-title">Псалми</div>
                    <div class="template-desc">150 днів</div>
                </div>
                <div class="template-card" onclick="app.selectTemplate('wisdom')">
                    <div class="template-icon">💡</div>
                    <div class="template-title">Мудрість</div>
                    <div class="template-desc">Притчі, Екклезіаст</div>
                </div>
            </div>

            <div class="ai-suggestions">
                <h3 style="margin-bottom: 15px;">🤖 Або попросіть ШІ створити план</h3>
                <div class="form-group">
                    <label>Оберіть готову тему або введіть свою:</label>
                    <select id="aiPreset" onchange="app.selectAIPreset()" style="margin-bottom: 10px;">
                        <option value="">-- Оберіть тему --</option>
                        <option value="📖 Хочу вивчати любов Божу за 7 днів">❤️ Любов Бога (7 днів)</option>
                        <option value="🙏 Створи план про віру та довіру Богові на 7 днів">🙏 Віра і довіра (7 днів)</option>
                        <option value="✝️ Хочу пізнати життя Ісуса Христа за 2 тижні">✝️ Життя Ісуса (14 днів)</option>
                        <option value="💪 План читання про силу молитви на 7 днів">💪 Сила молитви (7 днів)</option>
                        <option value="🔥 План читання про Духа Святого на 10 днів">🔥 Дух Святий (10 днів)</option>
                        <option value="💡 Створи план про мудрість із Приповістей на 2 тижні">💡 Мудрість (14 днів)</option>
                        <option value="🕊️ Хочу роздумувати над прощенням і милістю 7 днів">🕊️ Прощення і милість (7 днів)</option>
                        <option value="💔 Хочу знайти надію у важкі часи за тиждень">💔 Надія в скорботі (7 днів)</option>
                        <option value="🌈 Хочу зрозуміти Божі обітниці за 10 днів">🌈 Божі обітниці (10 днів)</option>
                        <option value="🌾 Хочу вивчати плоди Духа за 9 днів">🌾 Плоди Духа (9 днів)</option>
                        <option value="🌿 Хочу вчитися ходити у вірі за 7 днів">🌿 Ходіння у вірі (7 днів)</option>
                        <option value="🏔️ Створи план про Боже керівництво в житті на тиждень">🏔️ Боже керівництво (7 днів)</option>
                        <option value="❤️ Хочу читати про любов до ближнього 7 днів">❤️ Любов до ближнього (7 днів)</option>
                        <option value="🛡️ План читання про боротьбу з гріхом і спокусами 10 днів">🛡️ Боротьба з гріхом (10 днів)</option>
                        <option value="🌅 Хочу вивчати нове життя у Христі за 2 тижні">🌅 Нове життя у Христі (14 днів)</option>
                        <option value="🕯️ План читання про світло серед темряви 7 днів">🕯️ Світло у темряві (7 днів)</option>
                        <option value="⛪ План про Церкву та служіння на 10 днів">⛪ Церква і служіння (10 днів)</option>
                        <option value="👑 Створи план про Боже Царство за тиждень">👑 Боже Царство (7 днів)</option>
                        <option value="📜 Хочу роздумувати над Псалмами Давида 30 днів">📜 Псалми Давида (30 днів)</option>
                        <option value="📚 План про останні часи і вічність на 2 тижні">📚 Останні часи і вічність (14 днів)</option>
                    </select>
                    <textarea id="aiPrompt" placeholder="Або введіть власний запит: Наприклад, План читання про благодать на 10 днів..." style="min-height: 80px;"></textarea>
                </div>
                <button class="btn btn-primary" onclick="app.generateAIPlan()">✨ Згенерувати план</button>
            </div>

            <div id="manualPlanForm" style="display: none;">
                <form onsubmit="app.saveManualPlan(event)">
                    <div class="form-group">
                        <label>Назва плану *</label>
                        <input type="text" id="planName" required>
                    </div>
                    <div class="form-group">
                        <label>Опис</label>
                        <textarea id="planDescription"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="app.closeCreateModal()">Скасувати</button>
                        <button type="submit" class="btn btn-primary">Створити</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: AI Helper -->
    <div class="modal" id="aiModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🤖 ШІ-помічник</h2>
                <button class="close-btn" onclick="app.closeAIModal()">&times;</button>
            </div>
            <div style="margin-bottom: 20px;">
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <strong id="aiReadingTitle"></strong>
                    <p id="aiReadingRef" style="color: #4a90e2; margin-top: 5px;"></p>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="app.getAIHelp('summary')">📄 Короткий зміст</button>
                    <button class="btn btn-primary" onclick="app.getAIHelp('context')">📚 Контекст</button>
                    <button class="btn btn-primary" onclick="app.getAIHelp('parallels')">🔗 Паралелі</button>
                    <button class="btn btn-primary" onclick="app.getAIHelp('application')">💡 Застосування</button>
                </div>
                <div id="aiHelpResponse" style="display: none;"></div>
                <div id="aiHelpLoading" style="display: none;" class="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px; color: #666;">Думаю...</p>
                </div>
            </div>
            <div style="text-align: center;">
                <button class="btn btn-secondary" onclick="app.closeAIModal()">Закрити</button>
            </div>
        </div>
    </div>

    <!-- Modal: Help -->
    <div class="modal" id="helpModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>❓ Довідка</h2>
                <button class="close-btn" onclick="app.closeHelp()">&times;</button>
            </div>
            <div style="line-height: 1.8; color: #333;">
                <div style="background: linear-gradient(135deg, #4a90e222 0%, #357abd33 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid #4a90e2;">
                    <h3 style="color: #4a90e2; margin-bottom: 10px;">📖 Ласкаво просимо!</h3>
                    <p>План читання Біблії допоможе вам систематично вивчати Святе Письмо. Створюйте плани, відстежуйте прогрес та отримуйте допомогу від ШІ.</p>
                </div>

                <h3 style="color: #4a90e2; margin-bottom: 15px;">🚀 Як користуватися</h3>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <h4 style="color: #2196f3; margin-bottom: 8px;">1️⃣ Створення плану</h4>
                    <p>Оберіть готовий шаблон або попросіть ШІ створити персональний план на основі ваших потреб.</p>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <h4 style="color: #4caf50; margin-bottom: 8px;">2️⃣ Відстеження прогресу</h4>
                    <p>Відмічайте прочитані розділи галочкою. Слідкуйте за статистикою вгорі сторінки.</p>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <h4 style="color: #9c27b0; margin-bottom: 8px;">3️⃣ ШІ-помічник</h4>
                    <p>Натискайте 🤖 на картці читання, щоб отримати короткий зміст, контекст, паралельні місця та практичні поради.</p>
                </div>

                <h3 style="color: #4a90e2; margin-bottom: 15px; margin-top: 25px;">🤖 Можливості ШІ</h3>
                <ul style="padding-left: 20px;">
                    <li><strong>Генерація планів:</strong> ШІ створить персональний план за вашим запитом</li>
                    <li><strong>Короткий зміст:</strong> Основні ідеї розділу</li>
                    <li><strong>Історичний контекст:</strong> Коли і чому написано</li>
                    <li><strong>Паралельні місця:</strong> Зв'язки з іншими частинами Біблії</li>
                    <li><strong>Застосування:</strong> Як використати прочитане в житті</li>
                </ul>

                <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; border-left: 5px solid #4caf50; margin-top: 20px;">
                    <p style="margin: 0;"><strong>💡 Порада:</strong> ШІ — це помічник для вивчення, а не заміна особистого дослідження Писання та спілкування з Богом.</p>
                </div>
            </div>
            <div style="text-align: center; margin-top: 25px;">
                <button class="btn btn-primary" onclick="app.closeHelp()">Зрозуміло! 📖</button>
            </div>
        </div>
    </div>

    <script>
 const app = {
    plans: [],
    currentPlan: null,
    currentReading: null,
    lastAIResponse: null,
    API_KEY: atob("Z3NrX1NUelQyS1FFQko3MGNDb1hDSllaV0dkeWIzRlk5OHJHN2xvWXUxSmc1SnV0VFZOSzIyVHY="),
    API_URL: "https://api.groq.com/openai/v1/chat/completions",
    MODEL_NAME: "meta-llama/llama-4-maverick-17b-128e-instruct",

    init() {
        this.loadPlans();
        this.updateStats();
        this.renderPlans();
        this.renderContent();
    },

    loadPlans() {
        const saved = localStorage.getItem('biblePlans');
        if (saved) {
            this.plans = JSON.parse(saved);
        }
    },

    savePlans() {
        localStorage.setItem('biblePlans', JSON.stringify(this.plans));
        this.updateStats();
        this.renderPlans();
        this.renderContent();
    },

    updateStats() {
        let totalReadings = 0;
        let completedReadings = 0;
        let notesCount = 0;
        let lastReadDate = null;

        this.plans.forEach(plan => {
            totalReadings += plan.readings.length;
            plan.readings.forEach(r => {
                if (r.completed) {
                    completedReadings++;
                    if (r.completedDate) {
                        const date = new Date(r.completedDate).toDateString();
                        if (!lastReadDate || new Date(r.completedDate) > new Date(lastReadDate)) {
                            lastReadDate = r.completedDate;
                        }
                    }
                }
                if (r.notes) notesCount++;
            });
        });

        const streak = this.calculateStreak();
        const progress = totalReadings > 0 ? Math.round((completedReadings / totalReadings) * 100) : 0;

        document.getElementById('totalReadings').textContent = totalReadings;
        document.getElementById('completedReadings').textContent = completedReadings;
        document.getElementById('currentStreak').textContent = streak;
        document.getElementById('notesCount').textContent = notesCount;
        document.getElementById('progressBar').style.width = progress + '%';
    },

    calculateStreak() {
        const allReadings = [];
        this.plans.forEach(plan => {
            plan.readings.forEach(r => {
                if (r.completed && r.completedDate) {
                    allReadings.push(new Date(r.completedDate));
                }
            });
        });

        if (allReadings.length === 0) return 0;

        allReadings.sort((a, b) => b - a);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        let streak = 0;
        let checkDate = new Date(today);

        for (let i = 0; i < allReadings.length; i++) {
            const readDate = new Date(allReadings[i]);
            readDate.setHours(0, 0, 0, 0);

            if (readDate.getTime() === checkDate.getTime()) {
                streak++;
                checkDate.setDate(checkDate.getDate() - 1);
            } else if (readDate < checkDate) {
                break;
            }
        }

        return streak;
    },

    renderPlans() {
        const container = document.getElementById('plansList');
        if (this.plans.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Немає планів</div>';
            return;
        }

        container.innerHTML = this.plans.map((plan, index) => {
            const completed = plan.readings.filter(r => r.completed).length;
            const total = plan.readings.length;
            const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
            const isActive = this.currentPlan && this.currentPlan.id === plan.id;

            return `
                <div class="menu-item ${isActive ? 'active' : ''}" onclick="app.selectPlan(${plan.id})">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; margin-bottom: 5px;">${plan.name}</div>
                        <div style="font-size: 0.85em; opacity: 0.8;">${completed}/${total} (${progress}%)</div>
                    </div>
                </div>
            `;
        }).join('');
    },

    renderContent() {
        const container = document.getElementById('contentArea');
        
        if (!this.currentPlan) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">📖</div>
                    <h3>Оберіть план читання</h3>
                    <p>Або створіть новий</p>
                </div>
            `;
            return;
        }

        const plan = this.currentPlan;
        const completed = plan.readings.filter(r => r.completed).length;
        const total = plan.readings.length;
        const progress = total > 0 ? Math.round((completed / total) * 100) : 0;

        container.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h2 style="color: #4a90e2;">${plan.name}</h2>
                    ${plan.description ? `<p style="color: #666; margin-top: 5px;">${plan.description}</p>` : ''}
                </div>
                <button class="btn btn-delete" onclick="app.deletePlan(${plan.id})">🗑️ Видалити план</button>
            </div>

            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span><strong>Прогрес:</strong> ${completed} з ${total}</span>
                    <span><strong>${progress}%</strong></span>
                </div>
                <div class="progress-bar" style="height: 10px;">
                    <div class="progress-fill" style="width: ${progress}%;"></div>
                </div>
            </div>

            <div class="readings-grid">
                ${plan.readings.map((reading, index) => `
                    <div class="reading-card ${reading.completed ? 'completed' : ''} ${index === 0 && !reading.completed ? 'current' : ''}">
                        <div class="reading-header">
                            <div style="flex: 1;">
                                <div class="reading-title">День ${index + 1}</div>
                                <div class="reading-reference">${reading.reference}</div>
                                ${reading.theme ? `<span class="tag">${reading.theme}</span>` : ''}
                            </div>
                            <label class="checkbox-label">
                                <input type="checkbox" ${reading.completed ? 'checked' : ''} onchange="app.toggleComplete(${plan.id}, ${index})">
                                <span>${reading.completed ? '✅ Прочитано' : 'Прочитати'}</span>
                            </label>
                        </div>

                        ${reading.description ? `<div class="reading-description">${reading.description}</div>` : ''}

                        <div class="reading-meta">
                            ${reading.completed && reading.completedDate ? `<span>📅 ${new Date(reading.completedDate).toLocaleDateString('uk-UA')}</span>` : ''}
                            ${reading.notes ? `<span>📝 Є нотатки</span>` : ''}
                        </div>

                        <div class="reading-actions">
                            <button class="btn btn-ai" onclick="app.openAIHelper(${plan.id}, ${index})">🤖 ШІ-помічник</button>
                            <button class="btn btn-note" onclick="app.toggleNotes(${plan.id}, ${index})">📝 Нотатки</button>
                        </div>

                        <div class="notes-section" id="notes-${plan.id}-${index}">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">Мої нотатки:</label>
                            <textarea id="noteText-${plan.id}-${index}" onchange="app.saveNote(${plan.id}, ${index})">${reading.notes || ''}</textarea>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    },

    selectPlan(planId) {
        this.currentPlan = this.plans.find(p => p.id === planId);
        this.renderPlans();
        this.renderContent();
    },

    toggleComplete(planId, readingIndex) {
        const plan = this.plans.find(p => p.id === planId);
        if (!plan) return;

        const reading = plan.readings[readingIndex];
        reading.completed = !reading.completed;
        reading.completedDate = reading.completed ? new Date().toISOString() : null;

        this.savePlans();
    },

    toggleNotes(planId, readingIndex) {
        const notesSection = document.getElementById(`notes-${planId}-${readingIndex}`);
        if (notesSection) {
            notesSection.classList.toggle('active');
        }
    },

    saveNote(planId, readingIndex) {
        const plan = this.plans.find(p => p.id === planId);
        if (!plan) return;

        const noteText = document.getElementById(`noteText-${planId}-${readingIndex}`).value;
        plan.readings[readingIndex].notes = noteText;

        this.savePlans();
    },

    deletePlan(planId) {
        if (!confirm('Видалити цей план читання?')) return;

        this.plans = this.plans.filter(p => p.id !== planId);
        if (this.currentPlan && this.currentPlan.id === planId) {
            this.currentPlan = null;
        }
        this.savePlans();
    },

    openCreateModal() {
        document.getElementById('createModal').classList.add('active');
        document.getElementById('manualPlanForm').style.display = 'none';
        document.getElementById('aiPrompt').value = '';
        document.getElementById('aiPreset').value = '';
    },

    closeCreateModal() {
        document.getElementById('createModal').classList.remove('active');
    },

    selectAIPreset() {
        const select = document.getElementById('aiPreset');
        const textarea = document.getElementById('aiPrompt');
        if (select.value) {
            textarea.value = select.value;
        }
    },

    selectTemplate(template) {
        const templates = {
            custom: {
                name: 'Мій план',
                description: 'Власний план читання',
                readings: []
            },
            year: {
                name: 'Біблія за рік',
                description: 'Прочитайте всю Біблію за 365 днів',
                readings: this.generateYearPlan()
            },
            nt: {
                name: 'Новий Завіт',
                description: 'Весь Новий Завіт за 90 днів',
                readings: this.generateNTPlan()
            },
            gospels: {
                name: 'Чотири Євангелія',
                description: 'Читання всіх чотирьох Євангелій за місяць',
                readings: this.generateGospelsPlan()
            },
            psalms: {
                name: 'Книга Псалмів',
                description: 'По одному псалму на день',
                readings: this.generatePsalmsPlan()
            },
            wisdom: {
                name: 'Книги мудрості',
                description: 'Притчі, Екклезіаст, Йов',
                readings: this.generateWisdomPlan()
            }
        };

        if (template === 'custom') {
            document.getElementById('manualPlanForm').style.display = 'block';
        } else {
            const planData = templates[template];
            const plan = {
                id: Date.now(),
                name: planData.name,
                description: planData.description,
                readings: planData.readings,
                createdDate: new Date().toISOString()
            };

            this.plans.unshift(plan);
            this.currentPlan = plan;
            this.savePlans();
            this.closeCreateModal();
        }
    },

    saveManualPlan(e) {
        e.preventDefault();
        
        const plan = {
            id: Date.now(),
            name: document.getElementById('planName').value,
            description: document.getElementById('planDescription').value,
            readings: [],
            createdDate: new Date().toISOString()
        };

        this.plans.unshift(plan);
        this.currentPlan = plan;
        this.savePlans();
        this.closeCreateModal();
    },

    async generateAIPlan() {
        const prompt = document.getElementById('aiPrompt').value.trim();
        if (!prompt) {
            alert('Будь ласка, опишіть, який план ви хочете створити');
            return;
        }

        const loading = document.createElement('div');
        loading.className = 'loading';
        loading.innerHTML = '<div class="spinner"></div><p style="margin-top: 15px;">Створюю план...</p>';
        document.querySelector('#createModal .modal-content').appendChild(loading);

        try {
            const systemPrompt = `Ти - помічник для створення планів читання Біблії. Користувач опише, що хоче вивчати, а ти створиш структурований план.

ВАЖЛИВО: Відповідай ТІЛЬКИ у форматі JSON без жодного додаткового тексту:
{
  "name": "Назва плану українською",
  "description": "Короткий опис українською",
  "readings": [
    {
      "reference": "Книга розділи:вірші (наприклад: Матвій 5-7)",
      "theme": "Тема українською (1-3 слова)",
      "description": "Короткий опис того, що читатимемо користувач (1 речення українською)"
    }
  ]
}

Правила:
- Використовуй українські назви книг Біблії
- reference має бути конкретним (наприклад: "Матвій 1-2", "Псалом 23", "Буття 1-3")
- Створюй реалістичну кількість читань (7-90 днів)
- theme - коротка тема (наприклад: "Нагірна проповідь", "Створення світу")
- description - 1 речення про зміст`;

            const response = await fetch(this.API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.API_KEY}`
                },
                body: JSON.stringify({
                    model: this.MODEL_NAME,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: prompt }
                    ],
                    max_tokens: 2000,
                    temperature: 0.7
                })
            });

            if (!response.ok) throw new Error(`API error: ${response.status}`);

            const data = await response.json();
            let aiText = data.choices[0].message.content.trim();
            
            aiText = aiText.replace(/```json\n?/g, '').replace(/```\n?/g, '');
            
            const planData = JSON.parse(aiText);

            planData.readings = planData.readings.map(r => ({
                ...r,
                completed: false,
                completedDate: null,
                notes: ''
            }));

            const plan = {
                id: Date.now(),
                name: planData.name,
                description: planData.description,
                readings: planData.readings,
                createdDate: new Date().toISOString(),
                aiGenerated: true
            };

            this.plans.unshift(plan);
            this.currentPlan = plan;
            this.savePlans();
            this.closeCreateModal();

        } catch (error) {
            console.error('AI Error:', error);
            alert('❌ Помилка при створенні плану. Спробуйте ще раз або оберіть готовий шаблон.');
        } finally {
            loading.remove();
        }
    },

    openAIHelper(planId, readingIndex) {
        const plan = this.plans.find(p => p.id === planId);
        if (!plan) return;

        const reading = plan.readings[readingIndex];
        this.currentReading = { planId, readingIndex, reading };

        document.getElementById('aiReadingTitle').textContent = `День ${readingIndex + 1}`;
        document.getElementById('aiReadingRef').textContent = reading.reference;
        document.getElementById('aiHelpResponse').style.display = 'none';
        document.getElementById('aiModal').classList.add('active');
    },

    closeAIModal() {
        document.getElementById('aiModal').classList.remove('active');
        this.currentReading = null;
    },

    async getAIHelp(type) {
        if (!this.currentReading) return;

        const { reading } = this.currentReading;

        document.getElementById('aiHelpResponse').style.display = 'none';
        document.getElementById('aiHelpLoading').style.display = 'block';

        const prompts = {
            summary: `Дай короткий зміст (3-5 речень українською) біблійного уривка: ${reading.reference}. 
Фокус на головних подіях та ідеях. Без тлумачення, тільки факти про що там написано.`,

            context: `Поясни історичний та літературний контекст біблійного уривка: ${reading.reference}.
Українською мовою, 4-6 речень: коли написано, автор, до кого звернено, чому написано, яка ситуація.`,

            parallels: `Знайди 3-4 паралельні місця Писання до: ${reading.reference}.
Формат українською:
📖 [Посилання] - коротке пояснення зв'язку
Фокусуй на тематичних та текстуальних паралелях.`,

            application: `Дай практичні поради українською для застосування ${reading.reference} у сучасному житті.
2-3 конкретні пункти:
💡 [Порада] - як це застосувати
Будь практичним та релевантним для сьогодення.`
        };

        this.lastAIResponse = {
            type: type,
            reference: reading.reference,
            theme: reading.theme || 'Біблійне читання'
        };

        try {
            const response = await fetch(this.API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.API_KEY}`
                },
                body: JSON.stringify({
                    model: this.MODEL_NAME,
                    messages: [
                        {
                            role: 'system',
                            content: 'Ти - помічник для вивчення Біблії. Даєш точну інформацію про біблійні тексти. Не тлумачиш богословські питання глибоко, а даєш базову допомогу для розуміння тексту. Відповідаєш ТІЛЬКИ українською мовою.'
                        },
                        {
                            role: 'user',
                            content: prompts[type]
                        }
                    ],
                    max_tokens: 600,
                    temperature: 0.7
                })
            });

            if (!response.ok) throw new Error(`API error: ${response.status}`);

            const data = await response.json();
            const aiText = data.choices[0].message.content;

            this.lastAIResponse.content = aiText;

            const typeNames = {
                summary: '📄 Короткий зміст',
                context: '📚 Контекст',
                parallels: '🔗 Паралелі',
                application: '💡 Застосування'
            };

            document.getElementById('aiHelpLoading').style.display = 'none';
            document.getElementById('aiHelpResponse').style.display = 'block';
            document.getElementById('aiHelpResponse').innerHTML = `
                <div class="ai-response-box">
                    <div style="line-height: 1.8; white-space: pre-wrap;">${aiText}</div>
                </div>
                <div class="share-buttons">
                    <a href="#" onclick="app.shareToTelegram(); return false;" class="share-btn share-telegram">
                        📱 Поділитися в Telegram
                    </a>
                    <a href="#" onclick="app.shareToViber(); return false;" class="share-btn share-viber">
                        📱 Поділитися в Viber
                    </a>
                </div>
            `;

        } catch (error) {
            console.error('AI Error:', error);
            document.getElementById('aiHelpLoading').style.display = 'none';
            document.getElementById('aiHelpResponse').style.display = 'block';
            document.getElementById('aiHelpResponse').innerHTML = `
                <div class="ai-response-box">
                    <div style="color: #f44336;">❌ Помилка при отриманні відповіді. Спробуйте ще раз.</div>
                </div>
            `;
        }
    },

    generateYearPlan() {
        const books = [
            { name: 'Буття', chapters: 50 }, { name: 'Вихід', chapters: 40 },
            { name: 'Левит', chapters: 27 }, { name: 'Числа', chapters: 36 }
        ];
        
        const readings = [];
        let day = 0;
        
        for (let i = 0; i < Math.min(30, books.length); i++) {
            const book = books[i];
            const chaptersPerDay = Math.ceil(book.chapters / 3);
            
            for (let start = 1; start <= book.chapters; start += chaptersPerDay) {
                const end = Math.min(start + chaptersPerDay - 1, book.chapters);
                readings.push({
                    reference: `${book.name} ${start}${end > start ? '-' + end : ''}`,
                    theme: `${book.name}`,
                    description: `Читання розділів книги ${book.name}`,
                    completed: false,
                    completedDate: null,
                    notes: ''
                });
                day++;
                if (day >= 30) break;
            }
            if (day >= 30) break;
        }
        
        return readings;
    },

    generateNTPlan() {
        const ntBooks = [
            'Матвій', 'Марко', 'Лука', 'Іван', 'Діян', 'Римлян', 
            'Перше Коринтян', 'Друге Коринтян', 'Галатів'
        ];
        
        return ntBooks.slice(0, 30).map((book, i) => ({
            reference: `${book} 1-3`,
            theme: book,
            description: `Початок книги ${book}`,
            completed: false,
            completedDate: null,
            notes: ''
        }));
    },

    generateGospelsPlan() {
        const gospels = [
            { name: 'Матвій', chapters: 28 },
            { name: 'Марко', chapters: 16 },
            { name: 'Лука', chapters: 24 },
            { name: 'Іван', chapters: 21 }
        ];
        
        const readings = [];
        gospels.forEach(gospel => {
            const chaptersPerDay = Math.ceil(gospel.chapters / 7);
            for (let start = 1; start <= gospel.chapters; start += chaptersPerDay) {
                const end = Math.min(start + chaptersPerDay - 1, gospel.chapters);
                readings.push({
                    reference: `${gospel.name} ${start}-${end}`,
                    theme: gospel.name,
                    description: `Євангелія від ${gospel.name}`,
                    completed: false,
                    completedDate: null,
                    notes: ''
                });
            }
        });
        
        return readings;
    },

    generatePsalmsPlan() {
        const readings = [];
        for (let i = 1; i <= 30; i++) {
            readings.push({
                reference: `Псалом ${i}`,
                theme: `Псалом ${i}`,
                description: 'Щоденне читання Псалмів',
                completed: false,
                completedDate: null,
                notes: ''
            });
        }
        return readings;
    },

    generateWisdomPlan() {
        const readings = [];
        const books = [
            { name: 'Притчі', chapters: 31 },
            { name: 'Екклезіаст', chapters: 12 },
            { name: 'Йов', chapters: 42 }
        ];
        
        books.forEach(book => {
            for (let i = 1; i <= Math.min(book.chapters, 10); i++) {
                readings.push({
                    reference: `${book.name} ${i}`,
                    theme: book.name,
                    description: `Книга мудрості: ${book.name}`,
                    completed: false,
                    completedDate: null,
                    notes: ''
                });
            }
        });
        
        return readings;
    },

    exportData() {
        const dataStr = JSON.stringify(this.plans, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `bible_plans_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
    },

    openHelp() {
        document.getElementById('helpModal').classList.add('active');
    },

    closeHelp() {
        document.getElementById('helpModal').classList.remove('active');
    },

    shareToTelegram() {
        if (!this.lastAIResponse) return;
        
        const typeNames = {
            summary: '📄 Короткий зміст',
            context: '📚 Контекст',
            parallels: '🔗 Паралелі',
            application: '💡 Застосування'
        };
        
        const title = `📖 ${this.lastAIResponse.reference}`;
        const theme = this.lastAIResponse.theme;
        const type = typeNames[this.lastAIResponse.type] || 'ШІ-помічник';
        const content = this.lastAIResponse.content;
        
        const text = `${title}\n${type}\n\n${theme}\n\n${content}`;
        const url = `https://t.me/share/url?url=${encodeURIComponent(' ')}&text=${encodeURIComponent(text)}`;
        
        window.open(url, '_blank');
    },

    shareToViber() {
        if (!this.lastAIResponse) return;
        
        const typeNames = {
            summary: '📄 Короткий зміст',
            context: '📚 Контекст',
            parallels: '🔗 Паралелі',
            application: '💡 Застосування'
        };
        
        const title = `📖 ${this.lastAIResponse.reference}`;
        const theme = this.lastAIResponse.theme;
        const type = typeNames[this.lastAIResponse.type] || 'ШІ-помічник';
        const content = this.lastAIResponse.content;
        
        const text = `${title}\n${type}\n\n${theme}\n\n${content}`;
        const url = `viber://forward?text=${encodeURIComponent(text)}`;
        
        window.location.href = url;
    }
};

window.addEventListener('DOMContentLoaded', () => app.init());

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        app.closeCreateModal();
        app.closeAIModal();
        app.closeHelp();
    }
});

document.getElementById('createModal').addEventListener('click', (e) => {
    if (e.target.id === 'createModal') app.closeCreateModal();
});

document.getElementById('aiModal').addEventListener('click', (e) => {
    if (e.target.id === 'aiModal') app.closeAIModal();
});

document.getElementById('helpModal').addEventListener('click', (e) => {
    if (e.target.id === 'helpModal') app.closeHelp();
});

    </script>
</body>
</html>
